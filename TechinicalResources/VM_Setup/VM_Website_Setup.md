# How to set up your website in the VM

#### Getting into your VM

Open powershell (or terminal or cmd) and ssh into your project
```javascript
ssh into the server sangwonlee@PROJECT_NAME.cs.vt.edu       //Might be a IP instead of PROJECT_NAME
//Enter password
```

clone directory into your ssh 
```bash
git clone {REPO_NAME} 
```
With githubs ssh key changes it might be better to do a ssh clone over https. This helped me: https://stackoverflow.com/questions/46227434/cant-push-to-github-using-ssh when I tried to push to change from https to ssh.

#### Install Node

```javascript
sudo dnf install nodejs18 
//Can also use dnf over yum if using Rocky Linux 8
//replace 18 with the version you need
```

#### Install mondgodb (or your database)
MongoDB was not a yum or dnf dependency for me so I had to manually add it to the VM. Follow these steps if that is the case for you.

##### Step 1:
Create a repo. I use vi but you can use nano or vim if you are more familiar with those.
```bash
sudo vi /etc/yum.repos.d/mongodb-org.repo
```

##### Step 2:
Add all of this with vim (for mongo 6.0):
```bash
[mongodb-org-6.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/8/mongodb-org/6.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://pgp.mongodb.com/server-6.0.asc
```
I followed this website, but it might be outdated now: https://www.mongodb.com/docs/v6.0/tutorial/install-mongodb-on-red-hat/

##### Step 3:
Exit vi (:wq) and install mongo (yum or dnf)
```bash
sudo dnf install mongo-org
```
	
#### Run the database
We made a data directory in our server folder. You could theoretically just run it globally or with systemctl but this is recommended to keep everything together. If you don't have a server folder just run it in the src folder. You may also need sudo for the mongod function.
```bash
cd /GITHUB_NAME/server
mkdir data
mongod --dbpath ./data
```
At this time you should have mongo and can run.
Exit out (CTRL+C) and 
```bash
sudo dnf install screen
```
Screen lets us have multiple 'screens' of terminal running at once. We want to run our server then 'detach from that screen'
```javascript
screen                                      //should replace your terminal with a new 'screen'
mongod --dbpath ./data                      //same as previous
ctrl+a ctrl+d                               //dont press enter between it hit the two keys separately
//should now be back in your original screen with mongod running in the background
```
Other important screen commands you may need
```javascript
screen -ls                                 //don't forget the dash or you will make a new screen
//should get a list of running screens with their PIDs
screen -X -S PID_# quit                    //This will quit out of a screen
screen -r PID_#                            //To get back to a previous open screen

//FYI: You can press tab to fill in the PID to make things faster
```

Now that we are back in our main screen we can start up our server.

#### Install Dependencies
My server used npm but yarn and pnpm are also viable
```bash
npm i
```
Run your server however you do
```javascript
npm start                                   //or run dev
```

If you get a ECONNREFUSED error, go into server.js and change the mongo client from 'localhost:27017' to '127.0.0.1:27017' and it fixed my issues

#### Run project
My project was in a separate tab so here are my navigation steps
```javascript
screen                                   //To make a new screen to run my app
cd ../my-app
pnpm i                                  //Install dependencies (pnpm is better than npm)
pnpm run dev
```

This should allow you to view your server at PROJECT_NAME.cs.vt.edu:3000. if you are using a next/react project. This might be enough for you but if you need to run on HTTP or HTTPS read the following sections.

## Nginx set-up to run on HTTP or HTTPS

Nginx (pronounced "engine-x") is a popular open-source web server and reverse proxy server. It's known for its high performance, stability, and low resource consumption. Originally created to solve the C10k problem (handling 10,000+ simultaneous connections), Nginx is now widely used to serve web content, reverse proxy, cache, load balance, and more. It's known for its efficiency in handling static files, but it can also be used as a reverse proxy to pass requests to other software, like Node.js, to handle dynamic content. (generated by ChatGPT)

##### Installed Nginx on Rocky Linux 8:
Start by installing nginx.

```bash 
sudo dnf install nginx
````

#### Edit the configuration file
Edit the Nginx configuration file (nginx.conf) to set up a reverse proxy from Nginx to your Node.js application to run on port 3000 (replace 300 with your port)
	
```bash
sudo vi /etc/nginx/nginx.conf
```

You really only need to touch the server section. The rest should be good as it. Add or replace what is there with the following.

For HTTP set-up:
```
upstream SERVER_NAME {
	server localhost:3000;
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name PROJECT_NAME.cs.vt.edu;

	location / {
		proxy_pass http://SERVER_NAME;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
		proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
		proxy_redirect off;
}
```

HTTPS requires certs, so you need to get certs from VT or certbot (VT is recommended. I don't know the full process for certbot)
For HTTPS set-up with a single server/service do this:
```
upstream SERVER_NAME {
	server localhost:3000;
}

server {
	listen 443 ssl; 
	server_name PROJECT_NAME.cs.vt.edu;
	ssl_certificate /etc/nginx/certs/PROJECT_NAME.cs.vt.edu.pem;
	ssl_certificate_key /etc/nginx/certs/PROJECT_NAME.cs.vt.edu.new.key;

	location / {
		proxy_pass http://SERVER_NAME;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
		proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
		proxy_redirect off;
	}
}
```

HTTPS set up when using your own server.js and running it on a separate port:
(Aka my website was a nextJS project running on port 3000 and I had a node.js server running on port 8080)
You need to add another location block to redirect your requests:
```
upstream SERVER_NAME {
	server localhost:3000;
}

upstream requests {
	server localhost:8080;
}

server {
	listen 443 ssl; 
	server_name PROJECT_NAME.cs.vt.edu;
	ssl_certificate /etc/nginx/certs/PROJECT_NAME.cs.vt.edu.pem;
	ssl_certificate_key /etc/nginx/certs/PROJECT_NAME.cs.vt.edu.new.key;

	location / {
		proxy_pass http://SERVER_NAME;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
		proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
		proxy_redirect off;
	}

	location /research/ {
        proxy_pass http://requests;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        }

    }
}
```
Basically this adds in a redirect whenever it sees PROJECT_NAME.cs.vt.edu/research/. You will need to go into your server.js and index.js file and make sure all of your posts are redirected like so: app.post('/research/NAME/' ...).

#### Update firewall
We need to update firewall settings to allow traffic on ports. This example is for port 8080. I needed to do the same for my MongoDB port (8080) and port 80/443 for nginx

```javascript
sudo firewall-cmd --zone=public --query-port=8080/tcp
no                                                          //Response from server
sudo firewall-cmd --zone=public --add-port=8080/tcp --permanent
success                                                     //Response from server
sudo firewall-cmd --reload
success                                                     //Response from server
sudo firewall-cmd --zone=public --query-port=8080/tcp
yes                                                         //Response from server
```


#### Double check that everything works
Ensure that Nginx and your Node.js application were running and accessible. Make sure the status says it is running

```
sudo systemctl start nginx
sudo systemctl enable nginx
sudo systemctl status nginx
```

If nginx is already started use
```
sudo systemctl restart nginx
sudo systemctl status nginx
```
Or use reload if you wanna live life on the edge and not stop the process (can be preferred for nginx)

## Troubleshooting errors
If you run into a nginx error it could be due to sestatus blocking nginx
#### SELinux

Temporarily setting SELinux (sestatus) to permissive mode might fix you issues.
```
sudo setenforce 0
```
Then run project again. If that fixes things then you need to make adjustments to the SELinux policies
Run these commands to allow nginx through SELinux:
```
sudo grep nginx /var/log/audit/audit.log | grep denied
sudo grep nginx /var/log/audit/audit.log | grep denied | audit2allow -M nginx_proxy
sudo semodule -i nginx_proxy.pp
sudo semodule -l | grep nginx_proxy
sudo setenforce 1
sudo systemctl restart nginx
```
Hopefully this is all you need to get your system to run 


